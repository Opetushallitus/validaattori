<html>
  <head></head>
  <body>
      <h1>Todistusvalidaattoritesteri</h1>
      <input type="file" id="fileupload">
      <div id="result"></div>
      <script type="text/javascript" src="../../target/javascripts/hakurekisteri-validator.js"></script>
      <script>
        fileupload.addEventListener("change", function() {
          var file = fileupload.files[0]
          reader = new FileReader()
          reader.readAsText(file)
          reader.addEventListener("loadend", function() {
            validoiXmlTodistus(reader.result)
          })
        })

        function validoiXmlTodistus(xml) {
          var parser=new DOMParser();
          xmlDoc=parser.parseFromString(xml,"text/xml");

          console.log(xmlDoc)

          todistukset = haeTodistukset(xmlDoc)

          var result = todistukset.flatMap( hakurekisteri.perusopetus.validateTodistus )

          console.log(result)

          document.getElementById("result").textContent = JSON.stringify(result)
        }

        function haeTodistukset(xmlDoc) {
          return xmlSelect(xmlDoc, "perusopetus")
            .map(function(todistusEl) {
              return {
                  suoritus: { komo: "1.2.246.562.13.62959769647", tila: "VALMIS"},
                arvosanas: haeArvosanat(todistusEl),
                supressed: [],
              }
            })
        }

        function haeArvosanat(todistusEl) {
          return xmlSelect(todistusEl, "*")
            .flatMap(function(aineEl) {
              return xmlSelect(aineEl, "yhteinen,valinnainen")
                .map(function(arvosanaEl) {
                  return {
                    aine: aineEl.tagName,
                    arvio: { arvosana: arvosanaEl.textContent },
                    lisatieto: xmlSelect(aineEl, "tyyppi,kieli").map(function(lisatietoEl) {
                      return lisatietoEl.textContent
                    }).join("")
                  }
                })
            })
        }

        function xmlSelect(xml, selector) {
          return Array.prototype.slice.call(xml.querySelectorAll(selector))
        }

        Array.prototype.flatMap = function(f) {
              return Array.prototype.concat.apply([], this.map(f));
        };
      </script>
  </body>
</html>
