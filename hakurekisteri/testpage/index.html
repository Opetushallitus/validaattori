<html>
  <head>
      <style>
      pre {outline: 1px solid #ccc; padding: 5px; margin: 5px; }
        .string { color: green; }
        .number { color: darkorange; }
        .boolean { color: blue; }
        .null { color: magenta; }
        .key { color: red; }
      </style>
  </head>
  <body>
      <h1>Todistusvalidaattoritesteri</h1>
      <input type="file" id="fileupload">
      <pre id="result" ></pre>
      <script type="text/javascript" src="../../target/javascripts/goog/base.js"></script>

      <script type="text/javascript" src="../../target/javascripts/hakurekisteri-validator.js"></script>
      <script>
        goog.require('hakurekisteri.perusopetus')

        fileupload.addEventListener("change", function() {
          var file = fileupload.files[0]
          reader = new FileReader()
          reader.readAsText(file)
          reader.addEventListener("loadend", function() {
            validoiXmlTodistus(reader.result)
          })
        })

        function pad(n, p, c) {
            var pad_char = typeof c !== 'undefined' ? c : '0';
            var padding = new Array(1 + p).join(pad_char);
            return (padding + n).slice(-padding.length);
        }

        function time() {
            var d = new Date()
            return pad(d.getHours(), 2) + ":" +pad(d.getMinutes(),2) + ":" + pad(d.getSeconds(),2) + "." + pad(d.getMilliseconds(),3)
        }

        function validoiXmlTodistus(xml) {
            console.log("start: " + time())
          var parser=new DOMParser();

          xmlDoc=parser.parseFromString(xml,"text/xml");
                        console.log("parsed: " + time())


          console.log(xmlDoc)

          todistukset = haeTodistukset(xmlDoc)
                                  console.log("objects created: " + time())


          var result = todistukset.flatMap( hakurekisteri.perusopetus.validateTodistus )
                                    console.log("validation done: " + time())

          console.log(result)

                        document.getElementById("result").innerHTML  = syntaxHighlight(JSON.stringify(result,null,2))





        }

        function haeTodistukset(xmlDoc) {
          return xmlSelect(xmlDoc, "perusopetus")
            .map(function(todistusEl) {
              if (todistusEl.querySelector("eivalmistu"))
                  return {
                  suoritus: { komo: "1.2.246.562.13.62959769647", tila: "KESKEYTYNYT"},
                  arvosanas: [],
                  supressed: [],
              }
              return {
                  suoritus: { komo: "1.2.246.562.13.62959769647", tila: "VALMIS"},
                arvosanas: haeArvosanat(todistusEl),
                supressed: [],
              }
            })
        }

        function haeArvosanat(todistusEl) {
          return xmlSelect(todistusEl, "*")
            .flatMap(function(aineEl) {
              return xmlSelect(aineEl, "yhteinen,valinnainen")
                .map(function(arvosanaEl) {
                  return {
                    aine: aineEl.tagName,
                    arvio: { arvosana: arvosanaEl.textContent },
                    lisatieto: xmlSelect(aineEl, "tyyppi,kieli").map(function(lisatietoEl) {
                      return lisatietoEl.textContent
                    }).join(""),
                    valinnainen: arvosanaEl.tagName == "valinnainen"

                  }
                })
            })
        }

        function xmlSelect(xml, selector) {
          return Array.prototype.slice.call(xml.querySelectorAll(selector))
        }

        Array.prototype.flatMap = function(f) {
              return Array.prototype.concat.apply([], this.map(f));
        };

        function syntaxHighlight(json) {
            if (typeof json != 'string') {
                 json = JSON.stringify(json, undefined, 2);
            }
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

      </script>
  </body>
</html>
